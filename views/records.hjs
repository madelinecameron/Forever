<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://js.stripe.com/v2/"></script>

        <script type="application/javascript">
            Stripe.setPublishableKey('{{stripe_pk}}');
            $(document).ready(function() {
                document.getElementById('upload').addEventListener('change', function() {
                    $('#checkout').on('hidden.bs.modal', function(e) {
                        $('#upload').val('');
                    }).modal('hide');

                    $('#checkout').on('shown.bs.modal', function() {
                        var file = document.getElementById('upload').files[0];
                        $('#orderInfo').text('To store ' + file.size / 1000000000 + 'GB');
                        $('#submit').text('Pay $' + roundPrice(file.size / 1000000000 * {{price}}));
                    }).modal('show');

                    //uploadFile();
                }, false);

                var paySubmit = $('#submit');
                paySubmit.on('click', function() {
                    paySubmit.prop('disabled', true);
                    paySubmit.button('progress');

                    setTimeout(function() {
                        paySubmit.addClass('btn-success').removeClass('btn-primary');
                        paySubmit.button('success');
                        $('#checkout').modal('hide');
                        uploadFile(); //Upload after payment
                    }, 1500);

                    /*var cardNum = $('#card-num').val();
                    var cardExp = $('#card-exp').val().split('/');
                    var cardCVC = $('#card-cvc').val();

                    // First submit the card information to Stripe to get back a token
                    Stripe.card.createToken({
                        number: cardNum,
                        exp_month: cardExp[0],
                        exp_year: cardExp[1],
                        cvc: cardCVC
                    }, function(status, response) {
                        console.log("Submitted!");
                        var payForm = $('#form');
                        var token = response.id;

                        // Save the token into a hidden input field
                        payForm.append($('<input type="hidden" name="stripeToken" />').val(token));

                        // Now submit the form to our server so it can make the charge against the token
                        payForm.get(0).submit();

                        // All done!
                        setTimeout(function() {
                            $('#checkout').modal('hide');
                        }, 250);
                    });*/

                    return false;
                });

            });

            function uploadFile() {
                var fd = new FormData();
                var file = document.getElementById('upload').files[0];
                fd.append("upload", file);
                var xhr = new XMLHttpRequest();
                xhr.upload.addEventListener("progress", uploadProgress, false);
                xhr.open("POST", "/records");
                xhr.onreadystatechange = function() {
                    if(xhr.readyState == 4 && xhr.status == 200) {
                        status("Success!");
                        document.location.href = '/records/newRecord?id=' + xhr.response.replace(/\"*/g, '');
                    }
                };
                xhr.send(fd);
            }

            function uploadProgress(evt) {
                if (evt.lengthComputable) {
                    var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                    status(percentComplete.toString() + "%");
                }
            }

            function roundPrice(price) {
                if (price.toFixed(2) <= 0.31) { //31 cents is minimum because of Stripe fees.
                    return 0.31.toFixed(2); //To keep it at two digits
                }
                else {
                    return price.toFixed(2);
                }
            }

            function status(message) {
                $('#status').text(message);
            }

        </script>
    </head>
    <body>
        <form method="POST" enctype="multipart/form-data" action="/records">
            <input type="file" id="upload" name="upload"/><br/>
        </form>
        <div class="modal fade" id="checkout">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" id="closeModal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <span id="orderInfo"></span>
                        <form id="payForm" action="/charge" method="POST" class="form-horizontal">
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <div class="input-group">
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-credit-card"></span></span>
                                        <input id="card-num" class="form-control" type="text" size="16" placeholder="Card number" autofocus="autofocus" />
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                                        <input id="card-exp" class="form-control" type="text" size="5" placeholder="MM/YY" />
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span>
                                        <input id="card-cvc" class="form-control" type="text" size="4" placeholder="CVC" />
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button id="submit" type="button" class="btn btn-primary col-sm-12"
                                data-progress-text="<span class='glyphicon glyphicon-refresh fa-spin'></span>"
                                data-success-text="<span class='glyphicon glyphicon-ok'></span>"
                                >
                            Pay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>